<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faculty Profile - College ERP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="enhanced-styles.css">
  <link rel="stylesheet" href="text-visibility-fix.css">
  <link rel="stylesheet" href="fac-profile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    // ===== INLINE AUTH SERVICE =====
    const authService = {
      isAuthenticated() {
        return !!localStorage.getItem('college_erp_token');
      },
      isFaculty() {
        const user = JSON.parse(localStorage.getItem('college_erp_user') || '{}');
        return user.role === 'FACULTY';
      },
      showAccessDenied() {
        alert('Access denied. Faculty only.');
        window.location.href = 'login.html';
      }
    };
    
    // ===== FORCE AXIOS CONFIGURATION =====
    console.log('üîß Setting up axios with baseURL: http://localhost:8080/api');
    axios.defaults.baseURL = 'http://localhost:8080/api';
    axios.defaults.timeout = 10000;
    
    // Add authentication interceptor
    axios.interceptors.request.use(
      (config) => {
        const token = localStorage.getItem('college_erp_token');
        if (token) {
          config.headers.Authorization = `Bearer ${token}`;
          console.log('‚úÖ Token added to request');
        }
        console.log('üì§ Request URL:', config.baseURL + config.url);
        return config;
      },
      (error) => {
        console.error('‚ùå Request interceptor error:', error);
        return Promise.reject(error);
      }
    );
    
    // Response interceptor
    axios.interceptors.response.use(
      (response) => {
        console.log('‚úÖ Response received:', response.config.url);
        return response;
      },
      (error) => {
        console.error('‚ùå Response error:', error.message);
        if (error.response?.status === 401) {
          localStorage.clear();
          window.location.href = 'login.html';
        }
        return Promise.reject(error);
      }
    );
  </script>
  <style>
    body { background: #f8f9fa; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', Arial, sans-serif; }
    .profile-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .profile-header-card { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 40px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .profile-header-content { display: flex; align-items: center; gap: 30px; }
    .profile-photo-large { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .profile-photo-placeholder { width: 150px; height: 150px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-size: 60px; border: 5px solid white; }
    .profile-header-info h1 { margin: 0 0 10px 0; font-size: 2em; }
    .profile-header-info p { margin: 5px 0; opacity: 0.9; }
    .profile-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; margin-right: 10px; font-size: 0.9em; }
    .info-cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .info-card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .info-card-title { font-size: 1.2em; font-weight: 600; color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; padding-bottom: 10px; border-bottom: 2px solid #e9ecef; }
    .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
    .info-row:last-child { border-bottom: none; }
    .info-label { font-weight: 600; color: #555; }
    .info-value { color: #333; }
    .back-btn { position: fixed; top: 20px; left: 20px; width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; font-size: 20px; color: #3498db; z-index: 100; transition: all 0.3s; }
    .back-btn:hover { background: #3498db; color: white; transform: scale(1.05); }
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(3px); }
    .loading-spinner { text-align: center; }
    .loading-spinner i { font-size: 48px; color: #3498db; animation: spin 1s linear infinite; }
    .loading-spinner p { margin-top: 15px; color: #2c3e50; font-weight: 600; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Footer styling */
    footer { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 1.5rem; text-align: center; margin-top: 3rem; }
    .footer-bar { font-size: 0.9rem; color: rgba(255,255,255,0.9); }
    .footer-bar strong { color: #3498db; }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></button>

  <div class="profile-container">
    <div class="profile-header-card">
      <div class="profile-header-content">
        <div id="profilePhotoContainer">
          <div class="profile-photo-placeholder">
            <i class="fas fa-user-tie"></i>
          </div>
        </div>
        <div class="profile-header-info">
          <h1 id="facultyName">Loading...</h1>
          <p><span class="profile-badge" id="facultyId">Faculty ID</span> <span class="profile-badge" id="facultyStatus">Active</span></p>
          <p id="facultyDesignation">Designation</p>
          <p id="facultyDepartment">Department</p>
        </div>
      </div>
    </div>

    <div class="info-cards-grid">
      <div class="info-card">
        <div class="info-card-title"><i class="fas fa-user"></i> Personal Information</div>
        <div class="info-row"><span class="info-label">Email</span><span class="info-value" id="facultyEmail">-</span></div>
        <div class="info-row"><span class="info-label">Phone</span><span class="info-value" id="facultyPhone">-</span></div>
        <div class="info-row"><span class="info-label">Date of Birth</span><span class="info-value" id="facultyDob">-</span></div>
        <div class="info-row"><span class="info-label">Gender</span><span class="info-value" id="facultyGender">-</span></div>
        <div class="info-row"><span class="info-label">Blood Group</span><span class="info-value" id="facultyBloodGroup">-</span></div>
      </div>

      <div class="info-card">
        <div class="info-card-title"><i class="fas fa-graduation-cap"></i> Academic Details</div>
        <div class="info-row"><span class="info-label">Qualification</span><span class="info-value" id="facultyQualification">-</span></div>
        <div class="info-row"><span class="info-label">Specialization</span><span class="info-value" id="facultySpecialization">-</span></div>
        <div class="info-row"><span class="info-label">Experience</span><span class="info-value" id="facultyExperience">-</span></div>
        <div class="info-row"><span class="info-label">Employee ID</span><span class="info-value" id="facultyEmployeeId">-</span></div>
        <div class="info-row"><span class="info-label">Date of Joining</span><span class="info-value" id="facultyJoiningDate">-</span></div>
      </div>

      <div class="info-card">
        <div class="info-card-title"><i class="fas fa-map-marker-alt"></i> Contact & Address</div>
        <div class="info-row"><span class="info-label">Address</span><span class="info-value" id="facultyAddress">-</span></div>
        <div class="info-row"><span class="info-label">City</span><span class="info-value" id="facultyCity">-</span></div>
        <div class="info-row"><span class="info-label">State</span><span class="info-value" id="facultyState">-</span></div>
        <div class="info-row"><span class="info-label">Pincode</span><span class="info-value" id="facultyPincode">-</span></div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-bar">2025 ¬© <strong>Karunya Institute of Technology and Sciences</strong></div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Check authentication
      if (!authService.isAuthenticated()) {
        window.location.href = 'login.html';
        return;
      }

      if (!authService.isFaculty()) {
        authService.showAccessDenied();
        return;
      }

      await loadFacultyProfile();
    });

    async function loadFacultyProfile() {
      showLoading();
      try {
        console.log('üì• Fetching faculty profile...');
        const response = await axios.get('/faculty/profile');
        console.log('üì¶ Profile response:', response.data);

        if (response.data.success && response.data.data) {
          renderProfile(response.data.data);
        } else {
          throw new Error('Failed to load profile');
        }
      } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        alert('Failed to load profile: ' + error.message);
      } finally {
        hideLoading();
      }
    }

    function renderProfile(profile) {
      console.log('üé® Rendering profile:', profile);
      const user = profile.user || {};

      // Header info
      document.getElementById('facultyName').textContent = user.name || 'Faculty Name';
      document.getElementById('facultyId').textContent = profile.facultyId || profile.employeeId || 'N/A';
      document.getElementById('facultyStatus').textContent = profile.status || 'Active';
      document.getElementById('facultyDesignation').textContent = profile.designation || 'Faculty';
      document.getElementById('facultyDepartment').textContent = profile.department?.name || 'Department';

      // Personal Information
      document.getElementById('facultyEmail').textContent = user.email || '-';
      document.getElementById('facultyPhone').textContent = user.phone || profile.phone || '-';
      document.getElementById('facultyDob').textContent = profile.dateOfBirth ? new Date(profile.dateOfBirth).toLocaleDateString() : '-';
      document.getElementById('facultyGender').textContent = profile.gender || '-';
      document.getElementById('facultyBloodGroup').textContent = profile.bloodGroup || '-';

      // Academic Details
      document.getElementById('facultyQualification').textContent = profile.qualification || '-';
      document.getElementById('facultySpecialization').textContent = profile.specialization || '-';
      document.getElementById('facultyExperience').textContent = profile.experience ? profile.experience + ' years' : '-';
      document.getElementById('facultyEmployeeId').textContent = profile.employeeId || '-';
      document.getElementById('facultyJoiningDate').textContent = profile.joiningDate ? new Date(profile.joiningDate).toLocaleDateString() : '-';

      // Address
      document.getElementById('facultyAddress').textContent = profile.address || '-';
      document.getElementById('facultyCity').textContent = profile.city || '-';
      document.getElementById('facultyState').textContent = profile.state || '-';
      document.getElementById('facultyPincode').textContent = profile.pincode || '-';
    }

    function showLoading() {
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-overlay';
      loadingDiv.id = 'loadingOverlay';
      loadingDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner"></i><p>Loading profile...</p></div>';
      document.body.appendChild(loadingDiv);
    }

    function hideLoading() {
      const loadingDiv = document.getElementById('loadingOverlay');
      if (loadingDiv) loadingDiv.remove();
    }
  </script>
</body>
</html>
